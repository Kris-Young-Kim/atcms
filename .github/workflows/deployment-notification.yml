name: Staging Deployment Notification

on:
  workflow_run:
    workflows: ["Deploy to Staging"]
    types:
      - completed
      - failure

jobs:
  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Get workflow run details
        id: workflow-run
        uses: actions/github-script@v7
        with:
          script: |
            const { data: run } = await github.rest.actions.getWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id,
            });

            const { data: jobs } = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id,
            });

            const deployJob = jobs.jobs.find(job => job.name === 'Deploy to Staging');
            const status = deployJob?.conclusion === 'success' ? 'success' : 'failure';

            core.setOutput('status', status);
            core.setOutput('workflow_url', run.html_url);
            core.setOutput('commit_sha', run.head_sha.substring(0, 7));
            core.setOutput('branch', run.head_branch);

      - name: Create deployment summary
        uses: actions/github-script@v7
        env:
          STATUS: ${{ steps.workflow-run.outputs.status }}
          WORKFLOW_URL: ${{ steps.workflow-run.outputs.workflow_url }}
          COMMIT_SHA: ${{ steps.workflow-run.outputs.commit_sha }}
          BRANCH: ${{ steps.workflow-run.outputs.branch }}
        with:
          script: |
            const status = process.env.STATUS;
            const workflowUrl = process.env.WORKFLOW_URL;
            const commitSha = process.env.COMMIT_SHA;
            const branch = process.env.BRANCH;
            
            const emoji = status === 'success' ? '✅' : '❌';
            const statusText = status === 'success' ? '성공' : '실패';
            
            const summary = `
            ${emoji} **Staging 배포 알림**

            **상태**: ${statusText}
            **브랜치**: \`${branch}\`
            **커밋**: \`${commitSha}\`
            **실행 시간**: ${new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' })}

            [워크플로우 실행 보기](${workflowUrl})

            ---
            이 알림은 자동으로 생성되었습니다.
            `;

            console.log(summary);
            
            // TODO: Slack 알림 통합 (선택사항)
            // if (process.env.SLACK_WEBHOOK_URL) {
            //   await sendSlackNotification(summary);
            // }

