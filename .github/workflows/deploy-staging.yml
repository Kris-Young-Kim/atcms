name: Deploy to Staging

on:
  push:
    branches:
      - develop
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10.19.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run pre-deployment checklist script
        run: |
          chmod +x scripts/pre-deployment-check.sh
          ./scripts/pre-deployment-check.sh staging || true
        continue-on-error: true

      - name: Run linter
        run: pnpm --filter web lint

      - name: Run type check
        run: pnpm --filter web type-check

      - name: Run tests
        run: pnpm --filter web test:ci
        env:
          SKIP_ENV_VALIDATION: true
          NODE_ENV: test

      - name: Build application
        run: pnpm --filter web build
        env:
          SKIP_ENV_VALIDATION: true
          NODE_ENV: production

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Pull Vercel Environment Information
        run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}
        working-directory: ./web

      - name: Deploy to Vercel Preview (Staging)
        id: deploy
        run: vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }} --env=preview
        working-directory: ./web

      - name: Get deployment URL
        id: deployment-url
        run: |
          echo "url=${{ steps.deploy.outputs.url }}" >> $GITHUB_OUTPUT

      - name: Get PR number
        id: pr-number
        if: github.event_name == 'pull_request'
        run: |
          echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Get commit PR
        id: commit-pr
        if: github.event_name == 'push'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pulls } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${context.ref.replace('refs/heads/', '')}`,
            });
            
            if (pulls.length > 0) {
              core.setOutput('number', pulls[0].number);
            }
        continue-on-error: true

      - name: Comment deployment URL on PR
        if: steps.pr-number.outputs.number || steps.commit-pr.outputs.number
        uses: actions/github-script@v7
        env:
          DEPLOYMENT_URL: ${{ steps.deployment-url.outputs.url }}
          PR_NUMBER: ${{ steps.pr-number.outputs.number || steps.commit-pr.outputs.number }}
        with:
          script: |
            const prNumber = parseInt(process.env.PR_NUMBER);
            const deploymentUrl = process.env.DEPLOYMENT_URL;
            
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && comment.body.includes('Staging ë°°í¬')
            );
            
            const commitSha = context.sha.substring(0, 7);
            const commitUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/commit/${context.sha}`;
            
            const body = `## ğŸš€ Staging ë°°í¬ ì™„ë£Œ
            
            **ë°°í¬ URL**: [${deploymentUrl}](${deploymentUrl})
            **í™˜ê²½**: Preview (Staging)
            **ë¸Œëœì¹˜**: \`${context.ref.replace('refs/heads/', '')}\`
            **ì»¤ë°‹**: [\`${commitSha}\`](${commitUrl})
            **ë°°í¬ ì‹œê°„**: ${new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' })}
            
            ### ë°°í¬ ìƒíƒœ
            âœ… ë°°í¬ ì™„ë£Œ
            
            ### ë‹¤ìŒ ë‹¨ê³„
            - [ ] ë°°í¬ URL í™•ì¸
            - [ ] í•µì‹¬ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸
            - [ ] ì—ëŸ¬ ë¡œê·¸ í™•ì¸
            - [ ] ì„±ëŠ¥ í™•ì¸
            
            ë°°í¬ë¥¼ í™•ì¸í•˜ê³  í…ŒìŠ¤íŠ¸í•´ì£¼ì„¸ìš”.`;
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: body
              });
            }

      - name: Set deployment status badge
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ job.status }}' === 'success' ? 'success' : 'failure';
            const deploymentUrl = '${{ steps.deployment-url.outputs.url }}';
            
            // ë°°í¬ ìƒíƒœë¥¼ ì»¤ë°‹ì— ì½”ë©˜íŠ¸ë¡œ ì¶”ê°€
            const emoji = status === 'success' ? 'âœ…' : 'âŒ';
            const message = `${emoji} Staging ë°°í¬ ${status === 'success' ? 'ì„±ê³µ' : 'ì‹¤íŒ¨'}`;
            
            console.log(`Deployment Status: ${message}`);
            console.log(`Deployment URL: ${deploymentUrl || 'N/A'}`);

      - name: Notify deployment status
        if: always()
        uses: actions/github-script@v7
        env:
          DEPLOYMENT_URL: ${{ steps.deployment-url.outputs.url }}
        with:
          script: |
            const status = '${{ job.status }}' === 'success' ? 'âœ… ì„±ê³µ' : 'âŒ ì‹¤íŒ¨';
            const deploymentUrl = process.env.DEPLOYMENT_URL;
            const workflowUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const commitSha = context.sha.substring(0, 7);
            
            const body = `**Staging ë°°í¬ ìƒíƒœ**: ${status}
            
            ${deploymentUrl ? `**ë°°í¬ URL**: [${deploymentUrl}](${deploymentUrl})` : ''}
            **ë¸Œëœì¹˜**: \`${context.ref.replace('refs/heads/', '')}\`
            **ì»¤ë°‹**: \`${commitSha}\`
            **ì‹¤í–‰ ì‹œê°„**: ${new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' })}
            
            [ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ë³´ê¸°](${workflowUrl})`;
            
            console.log(body);
            // TODO: Slack ì•Œë¦¼ í†µí•© (ì„ íƒì‚¬í•­)
            // await sendSlackNotification({ status, deploymentUrl, body });

