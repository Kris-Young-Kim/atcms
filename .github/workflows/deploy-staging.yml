name: Deploy to Staging

on:
  push:
    branches:
      - develop
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10.19.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run linter
        run: pnpm --filter web lint

      - name: Run type check
        run: pnpm --filter web type-check

      - name: Run tests
        run: pnpm --filter web test:ci
        env:
          SKIP_ENV_VALIDATION: true
          NODE_ENV: test

      - name: Build application
        run: pnpm --filter web build
        env:
          SKIP_ENV_VALIDATION: true
          NODE_ENV: production

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Pull Vercel Environment Information
        run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}
        working-directory: ./web

      - name: Deploy to Vercel Preview (Staging)
        id: deploy
        run: vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }} --env=preview
        working-directory: ./web

      - name: Get deployment URL
        id: deployment-url
        run: |
          echo "url=${{ steps.deploy.outputs.url }}" >> $GITHUB_OUTPUT

      - name: Comment deployment URL on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && comment.body.includes('Staging ë°°í¬')
            );
            
            const body = `## ğŸš€ Staging ë°°í¬ ì™„ë£Œ
            
            **ë°°í¬ URL**: ${{ steps.deployment-url.outputs.url }}
            **í™˜ê²½**: Preview (Staging)
            **ë¸Œëœì¹˜**: \`${{ github.ref_name }}\`
            **ì»¤ë°‹**: \`${{ github.sha }}\`
            
            ë°°í¬ë¥¼ í™•ì¸í•˜ê³  í…ŒìŠ¤íŠ¸í•´ì£¼ì„¸ìš”.`;
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Notify deployment status
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ job.status }}' === 'success' ? 'âœ… ì„±ê³µ' : 'âŒ ì‹¤íŒ¨';
            const body = `**Staging ë°°í¬ ìƒíƒœ**: ${status}
            
            ${{ steps.deployment-url.outputs.url ? `**ë°°í¬ URL**: ${{ steps.deployment-url.outputs.url }}` : '' }}
            **ë¸Œëœì¹˜**: \`${{ github.ref_name }}\`
            **ì»¤ë°‹**: \`${{ github.sha }}\`
            
            [ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ë³´ê¸°](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})`;
            
            // Slack ì•Œë¦¼ ë“± ì¶”ê°€ ê°€ëŠ¥
            console.log(body);

