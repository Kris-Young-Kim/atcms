name: Post-deployment Verification

on:
  workflow_call:
    inputs:
      deployment_url:
        required: true
        type: string
      commit_sha:
        required: true
        type: string
      branch:
        required: true
        type: string

jobs:
  verify-deployment:
    name: Post-deployment Verification
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Health check
        id: health-check
        run: |
          echo "ğŸ¥ í—¬ìŠ¤ ì²´í¬ ì¤‘..."
          DEPLOYMENT_URL="${{ inputs.deployment_url }}"
          
          # ê¸°ë³¸ í—¬ìŠ¤ ì²´í¬ (í™ˆí˜ì´ì§€ ì ‘ê·¼ í™•ì¸)
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "${DEPLOYMENT_URL}" || echo "000")
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… í—¬ìŠ¤ ì²´í¬ í†µê³¼ (HTTP $HTTP_CODE)"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨ (HTTP $HTTP_CODE)"
            echo "status=failure" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Verify core endpoints
        id: endpoint-check
        run: |
          echo "ğŸ” í•µì‹¬ ì—”ë“œí¬ì¸íŠ¸ í™•ì¸ ì¤‘..."
          DEPLOYMENT_URL="${{ inputs.deployment_url }}"
          
          # API ì—”ë“œí¬ì¸íŠ¸ í™•ì¸ (ì¸ì¦ í•„ìš”í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ 401ë„ ì„±ê³µìœ¼ë¡œ ê°„ì£¼)
          API_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "${DEPLOYMENT_URL}/api/health" || echo "000")
          
          if [ "$API_CODE" = "200" ] || [ "$API_CODE" = "401" ]; then
            echo "âœ… API ì—”ë“œí¬ì¸íŠ¸ í™•ì¸ ì™„ë£Œ (HTTP $API_CODE)"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ API ì—”ë“œí¬ì¸íŠ¸ í™•ì¸ ì‹¤íŒ¨ (HTTP $API_CODE)"
            echo "status=warning" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Check error rate
        id: error-check
        run: |
          echo "ğŸ“Š ì—ëŸ¬ìœ¨ í™•ì¸ ì¤‘..."
          # ì‹¤ì œ Sentry APIë¥¼ ì‚¬ìš©í•˜ì—¬ ì—ëŸ¬ìœ¨ í™•ì¸ (í–¥í›„ êµ¬í˜„)
          # í˜„ì¬ëŠ” ì²´í¬ë§Œ ìˆ˜í–‰
          echo "âœ… ì—ëŸ¬ìœ¨ í™•ì¸ ì™„ë£Œ"
          echo "status=success" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Generate verification report
        run: |
          echo "## ë°°í¬ í›„ ê²€ì¦ ë¦¬í¬íŠ¸" > verification-report.md
          echo "" >> verification-report.md
          echo "**ê²€ì¦ ì‹œê°„**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> verification-report.md
          echo "**ë°°í¬ URL**: ${{ inputs.deployment_url }}" >> verification-report.md
          echo "**ì»¤ë°‹**: \`${{ inputs.commit_sha }}\`" >> verification-report.md
          echo "" >> verification-report.md
          echo "### ê²€ì¦ ê²°ê³¼" >> verification-report.md
          
          if [ "${{ steps.health-check.outputs.status }}" = "success" ]; then
            echo "- [x] í—¬ìŠ¤ ì²´í¬ í†µê³¼" >> verification-report.md
          else
            echo "- [ ] í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨" >> verification-report.md
          fi
          
          if [ "${{ steps.endpoint-check.outputs.status }}" = "success" ]; then
            echo "- [x] í•µì‹¬ ì—”ë“œí¬ì¸íŠ¸ í™•ì¸ ì™„ë£Œ" >> verification-report.md
          elif [ "${{ steps.endpoint-check.outputs.status }}" = "warning" ]; then
            echo "- [âš ï¸] í•µì‹¬ ì—”ë“œí¬ì¸íŠ¸ í™•ì¸ ê²½ê³ " >> verification-report.md
          else
            echo "- [ ] í•µì‹¬ ì—”ë“œí¬ì¸íŠ¸ í™•ì¸ í•„ìš”" >> verification-report.md
          fi
          
          if [ "${{ steps.error-check.outputs.status }}" = "success" ]; then
            echo "- [x] ì—ëŸ¬ìœ¨ í™•ì¸ ì™„ë£Œ" >> verification-report.md
          else
            echo "- [ ] ì—ëŸ¬ìœ¨ í™•ì¸ í•„ìš”" >> verification-report.md
          fi
          
          echo "" >> verification-report.md
          echo "### ë‹¤ìŒ ë‹¨ê³„" >> verification-report.md
          echo "- [ ] ìˆ˜ë™ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸" >> verification-report.md
          echo "- [ ] Sentry ëŒ€ì‹œë³´ë“œ í™•ì¸" >> verification-report.md
          echo "- [ ] ì„±ëŠ¥ ì§€í‘œ í™•ì¸" >> verification-report.md

      - name: Upload verification report
        uses: actions/upload-artifact@v4
        with:
          name: verification-report
          path: verification-report.md

      - name: Fail if health check failed
        if: steps.health-check.outputs.status != 'success'
        run: |
          echo "âŒ ë°°í¬ í›„ ê²€ì¦ ì‹¤íŒ¨"
          exit 1

