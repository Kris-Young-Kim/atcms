name: Rollback Deployment

on:
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ë§Œ ê°€ëŠ¥
    inputs:
      environment:
        description: 'ë°°í¬ í™˜ê²½ ì„ íƒ'
        required: true
        type: choice
        options:
          - staging
          - production
      deployment_url:
        description: 'ë¡¤ë°±í•  ë°°í¬ URL (ì„ íƒì‚¬í•­)'
        required: false
        type: string

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate inputs
        run: |
          if [ "${{ github.event.inputs.environment }}" != "staging" ] && [ "${{ github.event.inputs.environment }}" != "production" ]; then
            echo "âŒ ì˜ëª»ëœ í™˜ê²½ì…ë‹ˆë‹¤. staging ë˜ëŠ” productionë§Œ ì„ íƒ ê°€ëŠ¥í•©ë‹ˆë‹¤."
            exit 1
          fi
          echo "âœ… í™˜ê²½ ê²€ì¦ ì™„ë£Œ: ${{ github.event.inputs.environment }}"

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10.19.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Pull Vercel Environment Information
        run: vercel pull --yes --environment=${{ github.event.inputs.environment == 'production' && 'production' || 'preview' }} --token=${{ secrets.VERCEL_TOKEN }}
        working-directory: ./web

      - name: List recent deployments
        id: list-deployments
        run: |
          echo "ìµœê·¼ ë°°í¬ ë‚´ì—­ì„ í™•ì¸í•©ë‹ˆë‹¤..."
          vercel list --token=${{ secrets.VERCEL_TOKEN }} --environment=${{ github.event.inputs.environment == 'production' && 'production' || 'preview' }} --limit=10 > deployments.txt || true
          cat deployments.txt || echo "ë°°í¬ ë‚´ì—­ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."

      - name: Display deployment list
        run: |
          echo "## ìµœê·¼ ë°°í¬ ë‚´ì—­"
          cat deployments.txt || echo "ë°°í¬ ë‚´ì—­ ì—†ìŒ"

      - name: Rollback to previous deployment
        id: rollback
        if: github.event.inputs.deployment_url == ''
        run: |
          echo "ì´ì „ ë°°í¬ë¡œ ë¡¤ë°±í•©ë‹ˆë‹¤..."
          # Vercelì€ ìµœì‹  ë°°í¬ë¥¼ í”„ë¡œë•ì…˜ìœ¼ë¡œ í”„ë¡œëª¨íŠ¸í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ë¡¤ë°±
          # ì‹¤ì œ ë¡¤ë°±ì€ Vercel Dashboardì—ì„œ ìˆ˜í–‰í•˜ëŠ” ê²ƒì´ ë” ì•ˆì „í•©ë‹ˆë‹¤
          echo "âš ï¸ Vercel CLIë¥¼ í†µí•œ ì§ì ‘ ë¡¤ë°±ì€ ì œí•œì ì…ë‹ˆë‹¤."
          echo "ğŸ’¡ Vercel Dashboardì—ì„œ ì´ì „ ë°°í¬ë¥¼ Productionìœ¼ë¡œ í”„ë¡œëª¨íŠ¸í•˜ì„¸ìš”."
          echo "ğŸ“ ë¡¤ë°± ì ˆì°¨:"
          echo "   1. Vercel Dashboard ì ‘ì†"
          echo "   2. í”„ë¡œì íŠ¸ ì„ íƒ â†’ Deployments íƒ­"
          echo "   3. ì´ì „ ë°°í¬ ë²„ì „ ì„ íƒ"
          echo "   4. â‹¯ ë©”ë‰´ í´ë¦­ â†’ 'Promote to Production' ì„ íƒ"
          exit 1

      - name: Rollback to specific deployment
        id: rollback-specific
        if: github.event.inputs.deployment_url != ''
        run: |
          echo "íŠ¹ì • ë°°í¬ë¡œ ë¡¤ë°±í•©ë‹ˆë‹¤: ${{ github.event.inputs.deployment_url }}"
          echo "âš ï¸ Vercel CLIë¥¼ í†µí•œ ì§ì ‘ ë¡¤ë°±ì€ ì œí•œì ì…ë‹ˆë‹¤."
          echo "ğŸ’¡ Vercel Dashboardì—ì„œ ì§€ì •í•œ ë°°í¬ë¥¼ Productionìœ¼ë¡œ í”„ë¡œëª¨íŠ¸í•˜ì„¸ìš”."
          exit 1

      - name: Create rollback documentation
        if: always()
        run: |
          echo "# ë¡¤ë°± ì ˆì°¨ ë¬¸ì„œ" > rollback-guide.md
          echo "" >> rollback-guide.md
          echo "## ë¡¤ë°± ë°©ë²•" >> rollback-guide.md
          echo "" >> rollback-guide.md
          echo "### ë°©ë²• 1: Vercel Dashboardì—ì„œ ë¡¤ë°±" >> rollback-guide.md
          echo "" >> rollback-guide.md
          echo "1. **Vercel Dashboard ì ‘ì†**: https://vercel.com/dashboard" >> rollback-guide.md
          echo "2. í”„ë¡œì íŠ¸ ì„ íƒ â†’ **Deployments** íƒ­" >> rollback-guide.md
          echo "3. ì´ì „ ë°°í¬ ë²„ì „ ì„ íƒ" >> rollback-guide.md
          echo "4. **â‹¯** ë©”ë‰´ í´ë¦­ â†’ **Promote to Production** ì„ íƒ" >> rollback-guide.md
          echo "" >> rollback-guide.md
          echo "### ë°©ë²• 2: Gitìœ¼ë¡œ ë¡¤ë°±" >> rollback-guide.md
          echo "" >> rollback-guide.md
          echo "1. ì´ì „ ì»¤ë°‹ í™•ì¸:" >> rollback-guide.md
          echo "   \`\`\`bash" >> rollback-guide.md
          echo "   git log --oneline" >> rollback-guide.md
          echo "   \`\`\`" >> rollback-guide.md
          echo "" >> rollback-guide.md
          echo "2. ì´ì „ ì»¤ë°‹ìœ¼ë¡œ revert:" >> rollback-guide.md
          echo "   \`\`\`bash" >> rollback-guide.md
          echo "   git checkout main" >> rollback-guide.md
          echo "   git pull origin main" >> rollback-guide.md
          echo "   git revert <ë°°í¬_ì»¤ë°‹_í•´ì‹œ>" >> rollback-guide.md
          echo "   git push origin main" >> rollback-guide.md
          echo "   \`\`\`" >> rollback-guide.md
          echo "" >> rollback-guide.md
          echo "3. Vercel ìë™ ì¬ë°°í¬" >> rollback-guide.md
          echo "" >> rollback-guide.md
          echo "## ë¡¤ë°± í›„ í™•ì¸ì‚¬í•­" >> rollback-guide.md
          echo "" >> rollback-guide.md
          echo "- [ ] ì´ì „ ë²„ì „ìœ¼ë¡œ ì •ìƒ ë™ì‘ í™•ì¸" >> rollback-guide.md
          echo "- [ ] ë°ì´í„° ì •í•©ì„± í™•ì¸" >> rollback-guide.md
          echo "- [ ] ì—ëŸ¬ ëª¨ë‹ˆí„°ë§ í™•ì¸" >> rollback-guide.md
          echo "- [ ] ë¡¤ë°± ì‚¬ìœ  ë¬¸ì„œí™”" >> rollback-guide.md
          echo "" >> rollback-guide.md
          echo "## ë¡¤ë°± ì •ë³´" >> rollback-guide.md
          echo "" >> rollback-guide.md
          echo "- **í™˜ê²½**: ${{ github.event.inputs.environment }}" >> rollback-guide.md
          echo "- **ë¡¤ë°± ì‹œê°„**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> rollback-guide.md
          echo "- **ì‹¤í–‰ì**: ${{ github.actor }}" >> rollback-guide.md

      - name: Upload rollback guide
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rollback-guide
          path: rollback-guide.md

      - name: Create rollback issue
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const guide = fs.readFileSync('rollback-guide.md', 'utf8');
            
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ”„ ë¡¤ë°± ìš”ì²­: ${{ github.event.inputs.environment }}`,
              body: `## ë¡¤ë°± ìš”ì²­
              
              **í™˜ê²½**: ${{ github.event.inputs.environment }}
              **ìš”ì²­ì**: @${{ github.actor }}
              **ì‹œê°„**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
              
              ${guide}
              
              ---
              
              **ì£¼ì˜**: ë¡¤ë°±ì€ ì‹ ì¤‘í•˜ê²Œ ì§„í–‰í•´ì•¼ í•©ë‹ˆë‹¤. ìœ„ ê°€ì´ë“œë¥¼ ì°¸ê³ í•˜ì—¬ ë¡¤ë°±ì„ ìˆ˜í–‰í•˜ì„¸ìš”.`
            });
            
            console.log(`ë¡¤ë°± ì´ìŠˆ ìƒì„±ë¨: ${issue.data.html_url}`);

      - name: Notify rollback status
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ job.status }}' === 'success' ? 'âœ… ì™„ë£Œ' : 'âš ï¸ ì£¼ì˜ í•„ìš”';
            const body = `**ë¡¤ë°± ìƒíƒœ**: ${status}
            
            **í™˜ê²½**: ${{ github.event.inputs.environment }}
            **ìš”ì²­ì**: @${{ github.actor }}
            
            ë¡¤ë°±ì€ Vercel Dashboardì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ìˆ˜í–‰í•´ì•¼ í•©ë‹ˆë‹¤.
            ìì„¸í•œ ì ˆì°¨ëŠ” ìƒì„±ëœ ì´ìŠˆë¥¼ ì°¸ê³ í•˜ì„¸ìš”.`;
            
            console.log(body);
            // Slack ì•Œë¦¼ ë“± ì¶”ê°€ ê°€ëŠ¥

