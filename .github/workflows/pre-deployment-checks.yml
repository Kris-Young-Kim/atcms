name: Pre-deployment Checks

on:
  workflow_call:
  workflow_dispatch:

jobs:
  pre-deployment-checks:
    name: Pre-deployment Checks
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10.19.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run linter
        run: pnpm --filter web lint

      - name: Run type check
        run: pnpm --filter web type-check

      - name: Check for security vulnerabilities
        id: security-check
        run: |
          echo "ğŸ” ë³´ì•ˆ ì·¨ì•½ì  ê²€ì‚¬ ì¤‘..."
          pnpm --filter web audit --audit-level=moderate || security_issues=$?
          if [ "$security_issues" = "1" ]; then
            echo "âš ï¸ ë³´ì•ˆ ì·¨ì•½ì ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤."
            echo "has_issues=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… ë³´ì•ˆ ì·¨ì•½ì  ì—†ìŒ"
            echo "has_issues=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Run tests
        run: pnpm --filter web test:ci
        env:
          SKIP_ENV_VALIDATION: true
          NODE_ENV: test

      - name: Build application
        run: pnpm --filter web build
        env:
          SKIP_ENV_VALIDATION: true
          NODE_ENV: production

      - name: Check bundle size
        run: |
          echo "ğŸ“¦ ë²ˆë“¤ í¬ê¸° í™•ì¸ ì¤‘..."
          if [ -f "web/.next/analyze/client.html" ]; then
            echo "âœ… ë²ˆë“¤ ë¶„ì„ ë¦¬í¬íŠ¸ ìƒì„±ë¨"
          fi

      - name: Generate deployment checklist
        run: |
          echo "## ë°°í¬ ì „ ì²´í¬ë¦¬ìŠ¤íŠ¸" > deployment-checklist.md
          echo "" >> deployment-checklist.md
          echo "**ìƒì„± ì‹œê°„**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> deployment-checklist.md
          echo "" >> deployment-checklist.md
          echo "### ì½”ë“œ í’ˆì§ˆ" >> deployment-checklist.md
          echo "- [x] ESLint í†µê³¼" >> deployment-checklist.md
          echo "- [x] TypeScript íƒ€ì… ì²´í¬ í†µê³¼" >> deployment-checklist.md
          echo "- [x] í…ŒìŠ¤íŠ¸ í†µê³¼" >> deployment-checklist.md
          echo "- [x] ë¹Œë“œ ì„±ê³µ" >> deployment-checklist.md
          echo "" >> deployment-checklist.md
          echo "### ë³´ì•ˆ" >> deployment-checklist.md
          if [ "${{ steps.security-check.outputs.has_issues }}" = "true" ]; then
            echo "- [ ] ë³´ì•ˆ ì·¨ì•½ì  í™•ì¸ í•„ìš”" >> deployment-checklist.md
          else
            echo "- [x] ë³´ì•ˆ ì·¨ì•½ì  ê²€ì‚¬ í†µê³¼" >> deployment-checklist.md
          fi
          echo "" >> deployment-checklist.md
          echo "### ì„±ëŠ¥" >> deployment-checklist.md
          echo "- [x] ë²ˆë“¤ í¬ê¸° í™•ì¸ ì™„ë£Œ" >> deployment-checklist.md
          echo "" >> deployment-checklist.md
          echo "### ë‹¤ìŒ ë‹¨ê³„" >> deployment-checklist.md
          echo "- [ ] ìŠ¹ì¸ì ê²€í† " >> deployment-checklist.md
          echo "- [ ] ë³€ê²½ì‚¬í•­ í™•ì¸" >> deployment-checklist.md
          echo "- [ ] í™˜ê²½ ë³€ìˆ˜ í™•ì¸" >> deployment-checklist.md

      - name: Upload deployment checklist
        uses: actions/upload-artifact@v4
        with:
          name: deployment-checklist
          path: deployment-checklist.md

      - name: Check security issues
        if: steps.security-check.outputs.has_issues == 'true'
        run: |
          echo "âš ï¸ ë³´ì•ˆ ì·¨ì•½ì ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤."
          echo "ë°°í¬ ì „ì— ë³´ì•ˆ ì·¨ì•½ì ì„ í•´ê²°í•´ì£¼ì„¸ìš”."
          exit 1

