name: Environment Variables Security Check

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

jobs:
  check-secrets:
    name: Check for hardcoded secrets
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Ï†ÑÏ≤¥ ÌûàÏä§ÌÜ†Î¶¨ ÌïÑÏöî
      
      - name: Check for hardcoded API keys
        run: |
          echo "üîç Checking for hardcoded API keys..."
          
          # Clerk ÌÇ§ Ìå®ÌÑ¥ Í≤ÄÏÉâ (live ÌÇ§Îäî Ï†àÎåÄ Í∏àÏßÄ)
          if grep -r "pk_live_\|sk_live_" web/src --exclude-dir=node_modules 2>/dev/null; then
            echo "‚ùå ERROR: Hardcoded Clerk live keys found!"
            echo "Live keys must never be hardcoded in source code."
            exit 1
          fi
          
          # Supabase Service Role Key Ìå®ÌÑ¥ Í≤ÄÏÉâ (JWT ÌÜ†ÌÅ∞)
          # eyJÎ°ú ÏãúÏûëÌïòÎäî Í∏¥ Î¨∏ÏûêÏó¥ÏùÄ JWT ÌÜ†ÌÅ∞Ïùº Í∞ÄÎä•ÏÑ±Ïù¥ ÎÜíÏùå
          if grep -rE "eyJ[A-Za-z0-9_-]{100,}" web/src --exclude-dir=node_modules --exclude="*.test.ts" --exclude="*.test.tsx" 2>/dev/null | grep -v "placeholder\|example\|test"; then
            echo "‚ùå ERROR: Possible hardcoded JWT tokens found!"
            echo "JWT tokens (Supabase keys) must not be hardcoded in source code."
            exit 1
          fi
          
          # ÌôòÍ≤Ω Î≥ÄÏàò ÌååÏùºÏù¥ Ïª§Î∞ãÎêòÏßÄ ÏïäÏïòÎäîÏßÄ ÌôïÏù∏
          if git ls-files | grep -E "\.env\.local$|\.env$" | grep -v ".env.example"; then
            echo "‚ùå ERROR: .env files found in repository!"
            echo "Environment variable files should not be committed."
            exit 1
          fi
          
          echo "‚úÖ No hardcoded secrets found"
      
      - name: Check .gitignore
        run: |
          echo "üîç Checking .gitignore..."
          
          if ! grep -qE "\.env" .gitignore web/.gitignore 2>/dev/null; then
            echo "‚ö†Ô∏è  WARNING: .env files may not be properly ignored"
            echo "Please ensure .env files are listed in .gitignore"
          else
            echo "‚úÖ .env files are properly ignored"
          fi
      
      - name: Check for placeholder values
        run: |
          echo "üîç Checking for placeholder values..."
          
          # ÌîåÎ†àÏù¥Ïä§ÌôÄÎçî Í∞íÏùÄ ÌóàÏö©Îê®
          if grep -r "pk_test_placeholder\|sk_test_placeholder" web/src --exclude-dir=node_modules 2>/dev/null; then
            echo "‚ÑπÔ∏è  INFO: Placeholder values found (this is acceptable)"
          fi

